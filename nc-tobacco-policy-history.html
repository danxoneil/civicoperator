import React, { useMemo, useState } from "react";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { ScrollArea } from "@/components/ui/scroll-area";
import { ChevronDown, ChevronUp, Download, Search, Filter, RefreshCw, Printer } from "lucide-react";
import { motion, AnimatePresence } from "framer-motion";

/*
  Mecklenburg Tobacco Policy Timeline – Interactive Web Page
  Source: Timeline extracted from Mecklenburg County Public Health webpage (1969–2025)
  Features:
  - Full-text search
  - Decade filter
  - Smart tags auto-derived from entry text
  - Expand/collapse by year
  - Export to CSV / JSON
  - Print-friendly

  Notes:
  - This single-file React component is production-ready and uses shadcn/ui + Tailwind.
  - No external network calls are made; all data is embedded.
*/

// --- Data (exactly as extracted from the web timeline) ---
const TIMELINE: { year: number; items: string[] }[] = [
  { year: 1969, items: [
    "City of Charlotte ordinance bans smoking in shopping areas of retail stores with >200 people or 25 employees for fire safety.",
  ] },
  { year: 1989, items: [
    "City of Charlotte smoke-free ordinance for government-owned buildings.",
  ] },
  { year: 1993, items: [
    "Mecklenburg County: Project Assist funding started (Public Health).",
    "North Carolina: Law authorizes state/local governments to establish nonsmoking areas in government buildings.",
  ] },
  { year: 2000, items: [
    "Mecklenburg County adopts policy for smoke-free government buildings and vehicles; no smoking except designated areas at Charlotte-Douglas International Airport.",
    "NC Tobacco Prevention & Control Branch sets goal of achieving 100% tobacco-free schools.",
  ] },
  { year: 2003, items: [
    "Charlotte-Mecklenburg Schools adopt 100% tobacco-free policy for students, staff, and visitors (buildings, grounds, school events).",
  ] },
  { year: 2004, items: [
    "TRU funding from NC HWTF (youth focus) from 2003–2012.",
  ] },
  { year: 2005, items: [
    "Smoke Free Charlotte, which becomes Smoke Free Mecklenburg Coalition, starts.",
  ] },
  { year: 2006, items: [
    "Carolinas HealthCare System becomes 100% tobacco-free.",
    "Duke Endowment funds NC Prevention Partners (with NC Hospital Association) to help NC hospitals go 100% tobacco-free; NC Quitline launches.",
  ] },
  { year: 2007, items: [
    "City of Charlotte passes resolution to support local control of indoor air laws.",
    "State laws allow UNC institutions to regulate smoking in buildings/on grounds; set 100% tobacco-free policy for public school systems (effective Aug. 1, 2008); prohibit smoking in long-term care facilities and nursing homes; adopt fire-safe cigarette law.",
  ] },
  { year: 2008, items: [
    "City of Charlotte adopts tobacco-free policy for government buildings and vehicles.",
    "State laws mandate smoke-free state government buildings and authorize local governments to mandate smoke-free government buildings and vehicles.",
  ] },
  { year: 2009, items: [
    "CPCC adopts tobacco-free campus policy.",
    "CATS bus system adopts smoke-free policy for center and bus stop shelters.",
    "All 127 full-service NC hospitals are 100% tobacco-free.",
    "Cigarette tax per pack of 20: 45 cents (raised from 35 cents in 2009; prior change 5→35 cents in 2005–06).",
  ] },
  { year: 2010, items: [
    "UNC Charlotte adopts smoke-free policy for buildings and 100 ft. from doors.",
    "Mecklenburg County Public Health Department adopts tobacco-free grounds policy.",
    "House Bill 2 prohibits smoking in restaurants and bars; expands local government authority to regulate smoking on government grounds and certain enclosed public spaces.",
  ] },
  { year: 2011, items: [
    "City of Charlotte revises tobacco cessation benefits for employees.",
  ] },
  { year: 2012, items: [
    "Town of Cornelius adopts tobacco-free ordinance for parks; Town of Huntersville adopts smoke-free park policy.",
    "Town of Davidson adds no-smoking to Parks Use Policy.",
    "Charlotte Housing Authority: new and renovated buildings to open smoke-free.",
    "All state prison facilities go tobacco-free.",
  ] },
  { year: 2013, items: [
    "Tobacco Free Mecklenburg network launches.",
    "Mecklenburg County opens Romare Bearden Park tobacco-free.",
    "Johnson C. Smith University adopts tobacco-free campus policy.",
  ] },
  { year: 2014, items: [
    "Bank of America Stadium goes smoke-free.",
    "Johnson & Wales University adopts tobacco-free campus policy.",
    "Medic in Charlotte goes tobacco-free.",
    "State-operated mental health facilities go 100% tobacco-free.",
  ] },
  { year: 2015, items: [
    "Mecklenburg County Board of Health Rule: Smoke-Free Government Grounds (county and 7 municipalities). Mecklenburg County Tobacco-Free Parks Ordinance.",
    "2015–2016: Juul launches youth-focused marketing campaign (national).",
    "E-cigarette tax: 5 cents per milliliter of consumable nicotine solution (effective June 1, 2015; G.S. 105-113.35(a)).",
  ] },
  { year: 2016, items: [
    "BB&T Stadium goes tobacco-free.",
    "HUD (federal) adopts smoke-free housing policy for housing authorities using Public Housing funding (voucher-based not covered).",
  ] },
  { year: 2017, items: [
    "GCAA Smoke-Free Multiunit Housing Certification initiative launches (69 smoke-free properties by 2022).",
    "Statewide childcare facilities go tobacco-free.",
  ] },
  { year: 2018, items: [
    "Mecklenburg County Public Health’s Village HeartBEAT and AHA support 8 Black/African American churches taking campuses tobacco-free.",
    "Federal law increases tobacco purchase age to 21 and bans flavored e-cig pods.",
    "2017–2019: Peak of Juul popularity among youth.",
  ] },
  { year: 2019, items: [
    "Charlotte-Douglas International Airport goes tobacco-free for all vendors and business partners (≈20,000 people); two outdoor passenger smoking areas remain.",
  ] },
  { year: 2020, items: [
    "Change for Life: Tobacco-Free Recovery Initiative launches to support tobacco-free behavioral health.",
    "NC Breathe Easy Initiative supporting tobacco-free behavioral health launches.",
  ] },
  { year: 2021, items: [
    "McLeod Centers for Well Being (SUD treatment) adopts tobacco-free campus.",
    "Charlotte Rescue Mission adopts tobacco-free campus.",
    "NC’s JUUL Settlement passes June 2021 ($40M; increased to $47.8M in 2023).",
  ] },
  { year: 2022, items: [
    "Anuvia Prevention & Treatment goes tobacco-free (previously smoke-free in detox only).",
    "Harmony Health mental health agency goes tobacco-free.",
    "Hope Haven (SUD treatment) goes tobacco-free.",
    "Queens University adopts tobacco-free campus.",
    "Hope Community Clinic goes tobacco-free.",
    "Daymark (mental health) goes tobacco-free.",
    "G.S. 90-85.15B: Immunizing pharmacists can dispense, deliver, or administer FDA-approved nicotine replacement therapy (standing order by NC DHHS Chief Medical Officer and State Health Director).",
    "Tax on cigars: 12.8% of wholesale price, capped at 30 cents (G.S. 105-113.36A; effective July 1, 2022).",
  ] },
  { year: 2023, items: [
    "Clearing the Smoke — Mecklenburg Tobacco-Free Coalition with multicultural focus launches.",
    "NC MedAssist goes tobacco-free, including statewide over-the-counter events.",
    "Tobacco point-of-sale data collection (2023 & 2025); T-21 and retail permitting advocacy.",
    "State law (HB900) creates NC Vapor Registry (amends Youth Access Law G.S. 14-313 (g)–(i)).",
  ] },
  { year: 2024, items: [
    "Northeastern University adopts tobacco-free campus in Charlotte and 11 campuses nationwide.",
    "Smith Family Behavioral Health Urgent Care goes tobacco-free.",
    "Monarch (mental health) goes tobacco-free.",
  ] },
  { year: 2025, items: [
    "BOCC signs proclamation supporting NC T-21 and tobacco retail licensure.",
    "Charlotte Pride takes Youth and Family Zone of Pride Festival tobacco-free and moves event to tobacco-free First Ward Park.",
    "NC Tobacco Prevention & Control staff furloughed after CDC stop-work order and Office of Smoking and Health eliminated; regional staff funding switched to JUUL settlement.",
    "Tobacco-free campus policy requirement for NC Medicaid and state-funded service providers (medical, behavioral health, I/DD, TBI). Effective date now January 2027 (moved multiple times).",
  ] },
];

// Utility: derive tags from text
const deriveTags = (text: string): string[] => {
  const tags = new Set<string>();
  const t = text.toLowerCase();
  if (/(mecklenburg|county|bocc|mcp|meck)/i.test(text)) tags.add("County");
  if (/(city of charlotte|charlotte|cats|bb&t stadium|bank of america stadium)/i.test(text)) tags.add("City");
  if (/(north carolina|nc\b|g\.s\.|house bill|unc|state law|statewide)/i.test(text)) tags.add("State");
  if (/(federal|hud)/i.test(text)) tags.add("Federal");
  if (/(university|college|school|cpcc|unc charlotte|johnson|wales|queens)/i.test(text)) tags.add("Education");
  if (/(hospital|healthcare|clinic|medassist|behavioral health|sud|mental health|quitline|pharmacist|nicotine replacement)/i.test(text)) tags.add("Health");
  if (/(airport)/i.test(text)) tags.add("Transportation");
  if (/(tax|cents|registry)/i.test(text)) tags.add("Finance/Regulation");
  if (/(coalition|network)/i.test(text)) tags.add("Coalitions");
  return Array.from(tags);
};

// Flatten into entries with tags for easier filtering
type Media = { type: 'image'; src: string; alt?: string };

type Entry = { id: string; year: number; text: string; tags: string[]; media?: Media[] };

// Optional media per entry (keyed by `${year}-${index}`)
// NOTE: Update the `src` to a hosted URL or local public asset path when deploying.
const MEDIA_MAP: Record<string, Media[]> = {
  '2005-0': [
    { type: 'image', src: '/meck-2005.png', alt: 'Putting Research and Best Practices into Action cover' }
  ],
};

const ENTRIES: Entry[] = TIMELINE.flatMap((y) =>
  y.items.map((text, i) => {
    const id = `${y.year}-${i}`;
    return { id, year: y.year, text, tags: deriveTags(text), media: MEDIA_MAP[id] || [] };
  })
);

const uniqueDecades = Array.from(new Set(TIMELINE.map((y) => Math.floor(y.year / 10) * 10))).sort((a, b) => a - b);
const allTags = Array.from(new Set(ENTRIES.flatMap((e) => e.tags))).sort();

function exportJSON(entries: Entry[]) {
  const blob = new Blob([JSON.stringify(entries, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "meck-tobacco-policy-timeline.json";
  a.click();
  URL.revokeObjectURL(url);
}

function exportCSV(entries: Entry[]) {
  const header = ["year", "text", "tags"].join(",");
  const rows = entries.map((e) =>
    [e.year, '"' + e.text.replaceAll('"', '""') + '"', '"' + e.tags.join(";") + '"'].join(",")
  );
  const csv = [header, ...rows].join("\n");
  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "meck-tobacco-policy-timeline.csv";
  a.click();
  URL.revokeObjectURL(url);
}

export default function TimelinePage() {
  const [query, setQuery] = useState("");
  const [decade, setDecade] = useState<number | "all">("all");
  const [tagFilters, setTagFilters] = useState<string[]>([]);
  const [openYears, setOpenYears] = useState<Set<number>>(new Set());

  const toggleYear = (year: number) => {
    setOpenYears((prev) => {
      const next = new Set(prev);
      if (next.has(year)) next.delete(year); else next.add(year);
      return next;
    });
  };

  const resetFilters = () => {
    setQuery("");
    setDecade("all");
    setTagFilters([]);
    setOpenYears(new Set());
  };

  const filtered = useMemo(() => {
    const q = query.trim().toLowerCase();
    return ENTRIES.filter((e) => {
      if (decade !== "all" && Math.floor(e.year / 10) * 10 !== decade) return false;
      if (tagFilters.length && !tagFilters.every((t) => e.tags.includes(t))) return false;
      if (q && !(e.text.toLowerCase().includes(q) || String(e.year).includes(q))) return false;
      return true;
    }).sort((a, b) => a.year - b.year);
  }, [query, decade, tagFilters]);

  // Group filtered results by year
  const byYear = useMemo(() => {
    const map = new Map<number, Entry[]>();
    for (const e of filtered) {
      if (!map.has(e.year)) map.set(e.year, []);
      map.get(e.year)!.push(e);
    }
    return Array.from(map.entries()).sort((a, b) => a[0] - b[0]);
  }, [filtered]);

  const exportEntries = () => exportCSV(filtered);

  return (
    <div className="min-h-screen bg-gradient-to-b from-purple-50 to-white text-slate-800">
      <header className="sticky top-0 z-20 backdrop-blur bg-white/70 border-b">
        <div className="max-w-6xl mx-auto px-4 py-4 flex items-center gap-3">
          <div className="flex-1">
            <h1 className="text-2xl md:text-3xl font-semibold">Mecklenburg Tobacco Policy Timeline (1969–2025)</h1>
            <p className="text-sm md:text-base text-slate-600">Interactive reference built from the Mecklenburg County Public Health webpage timeline.</p>
          </div>
          <div className="hidden md:flex gap-2">
            <Button variant="outline" onClick={() => window.print()} className="rounded-2xl"><Printer className="w-4 h-4 mr-2"/>Print</Button>
            <Button variant="default" onClick={() => exportJSON(filtered)} className="rounded-2xl"><Download className="w-4 h-4 mr-2"/>JSON</Button>
            <Button variant="default" onClick={exportEntries} className="rounded-2xl"><Download className="w-4 h-4 mr-2"/>CSV</Button>
          </div>
        </div>
      </header>

      <main className="max-w-6xl mx-auto px-4 py-6 grid md:grid-cols-4 gap-6">
        {/* Filters */}
        <aside className="md:col-span-1 space-y-4">
          <Card className="shadow-sm">
            <CardHeader className="pb-2"><CardTitle className="text-base flex items-center gap-2"><Filter className="w-4 h-4"/>Filters</CardTitle></CardHeader>
            <CardContent className="space-y-3">
              <div className="relative">
                <Search className="w-4 h-4 absolute left-2 top-1/2 -translate-y-1/2"/>
                <Input value={query} onChange={(e) => setQuery(e.target.value)} placeholder="Search text or year…" className="pl-8"/>
              </div>

              <div>
                <label className="text-sm font-medium">Decade</label>
                <select
                  className="mt-1 w-full border rounded-md p-2"
                  value={decade === "all" ? "all" : String(decade)}
                  onChange={(e) => setDecade(e.target.value === "all" ? "all" : Number(e.target.value))}
                >
                  <option value="all">All decades</option>
                  {uniqueDecades.map((d) => (
                    <option key={d} value={d}>{d}s</option>
                  ))}
                </select>
              </div>

              <div>
                <label className="text-sm font-medium">Tags</label>
                <ScrollArea className="h-40 mt-2 p-1 border rounded-md">
                  <div className="flex flex-wrap gap-2 p-1">
                    {allTags.map((t) => {
                      const active = tagFilters.includes(t);
                      return (
                        <button
                          key={t}
                          onClick={() => setTagFilters((prev) => active ? prev.filter((x) => x !== t) : [...prev, t])}
                          className={`text-xs px-2 py-1 rounded-full border ${active ? "bg-black text-white" : "bg-white hover:bg-slate-50"}`}
                          aria-pressed={active}
                        >
                          {t}
                        </button>
                      );
                    })}
                  </div>
                </ScrollArea>
              </div>

              <div className="flex gap-2">
                <Button variant="outline" className="rounded-2xl w-full" onClick={resetFilters}><RefreshCw className="w-4 h-4 mr-2"/>Reset</Button>
              </div>
            </CardContent>
          </Card>

          <Card className="shadow-sm">
            <CardHeader className="pb-2"><CardTitle className="text-base">About</CardTitle></CardHeader>
            <CardContent className="text-sm text-slate-600 space-y-2">
              <p>Entries are grouped by year. Click a year to expand. Tags are auto-derived from the text to help with filtering.</p>
              <p>Use the buttons at the top-right to export the filtered view to CSV/JSON or to print.</p>
            </CardContent>
          </Card>
        </aside>

        {/* Timeline */}
        <section className="md:col-span-3 space-y-4">
          {byYear.length === 0 ? (
            <p className="text-slate-600">No results match your filters.</p>
          ) : (
            byYear.map(([year, entries]) => {
              const open = openYears.has(year);
              return (
                <Card key={year} className="overflow-hidden shadow-sm">
                  <button
                    className="w-full text-left px-4 py-3 flex items-center justify-between bg-white hover:bg-slate-50"
                    onClick={() => toggleYear(year)}
                    aria-expanded={open}
                  >
                    <div className="flex items-center gap-3">
                      <div className="w-16 text-xl font-semibold text-slate-900">{year}</div>
                      <div className="text-sm text-slate-600">{entries.length} item{entries.length > 1 ? "s" : ""}</div>
                    </div>
                    {open ? <ChevronUp className="w-5 h-5"/> : <ChevronDown className="w-5 h-5"/>}
                  </button>

                  <AnimatePresence initial={false}>
                    {open && (
                      <motion.div
                        key="content"
                        initial={{ height: 0, opacity: 0 }}
                        animate={{ height: "auto", opacity: 1 }}
                        exit={{ height: 0, opacity: 0 }}
                        transition={{ duration: 0.2 }}
                      >
                        <CardContent className="pt-0">
                          <ul className="divide-y">
                            {entries.map((e) => (
                              <li key={e.id} className=\"py-3\">
  <div className=\"flex items-start gap-3\">
    <p className=\"leading-relaxed flex-1\">{e.text}</p>
    {e.media && e.media.find(m => m.type === 'image') && (
      <img
        src={(e.media.find(m => m.type === 'image') as any).src}
        alt={(e.media.find(m => m.type === 'image') as any).alt || 'Related image'}
        className=\"w-28 h-28 object-cover rounded-md border shadow-sm\"
      />
    )}
    <div className=\"shrink-0 flex items-center gap-2\">
      <a
        href=\"#\"
        onClick={(ev) => ev.preventDefault()}
        aria-label=\"PDF link\"
        title=\"Add a PDF link for this item by extending the data model (see About).\"
        className=\"inline-flex items-center justify-center w-8 h-8 border rounded-md hover:bg-slate-50\"
      >
        <svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\" width=\"18\" height=\"18\" aria-hidden=\"true\">
          <path d=\"M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z\" fill=\"none\" stroke=\"currentColor\"/>
          <path d=\"M14 2v6h6\" fill=\"none\" stroke=\"currentColor\"/>
          <text x=\"7\" y=\"17\" fontSize=\"7\" fontFamily=\"monospace\">PDF</text>
        </svg>
      </a>
    </div>
  </div>
</li>
                            ))}
                          </ul>
                        </CardContent>
                      </motion.div>
                    )}
                  </AnimatePresence>
                </Card>
              );
            })
          )}
        </section>
      </main>

      <footer className="max-w-6xl mx-auto px-4 pb-10 pt-2 text-xs text-slate-500">
        Built for publication as a single-page web view. Data source: Mecklenburg County Public Health – Tobacco Policy Timeline (webpage extract, 1969–2025).
      </footer>

      <style>{`
        @media print {
          header { position: static; border: none; }
          main { grid-template-columns: 1fr !important; }
          aside { display: none; }
          section .shadow-sm { box-shadow: none !important; }
        }
      `}</style>
    </div>
  );
}
