name: Extract RHT Topics

on:
  workflow_dispatch:
    inputs:
      urls:
        description: 'URL(s) to extract topics from (space-separated for multiple)'
        required: true
        type: string
      create_items:
        description: 'Create topic items on monday.com topics board'
        required: true
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

permissions:
  issues: write
  contents: read

jobs:
  extract:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          cd state-spending-monitor
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install spacy pypdf
          python -m spacy download en_core_web_sm

      - name: Run topic extraction
        env:
          MONDAY_API_TOKEN: ${{ secrets.MONDAY_API_TOKEN }}
          MONDAY_TOPICS_BOARD_ID: ${{ secrets.MONDAY_TOPICS_BOARD_ID }}
        run: |
          cd state-spending-monitor
          # Build --url flags from space-separated input
          URL_FLAGS=""
          for url in ${{ inputs.urls }}; do
            URL_FLAGS="$URL_FLAGS --url $url"
          done
          if [ "${{ inputs.create_items }}" = "true" ]; then
            python extract_topics.py $URL_FLAGS --create-items
          else
            python extract_topics.py $URL_FLAGS
          fi

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: topic-extraction-results
          path: |
            state-spending-monitor/topics-results.json
            state-spending-monitor/extract-topics.log
          retention-days: 30

      - name: Create report issue
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let output = { results: [], created_items: [], total_topics: 0, total_created: 0 };
            const path = 'state-spending-monitor/topics-results.json';
            if (fs.existsSync(path)) {
              output = JSON.parse(fs.readFileSync(path, 'utf8'));
            }

            const runDate = new Date().toISOString().split('T')[0];

            let title = `[Topics] ${output.total_topics} phrases extracted`;
            if (output.total_created > 0) {
              title += `, ${output.total_created} created on monday.com`;
            }
            title += ` (${runDate})`;

            let body = `## Topic Extraction Report â€” ${runDate}\n\n`;
            body += `**Total topics extracted:** ${output.total_topics}\n`;
            body += `**Items created on monday.com:** ${output.total_created}\n\n`;

            for (const result of output.results) {
              const stateLabel = result.state
                ? `${result.state_name} (${result.state})`
                : 'Unknown state';
              body += `### ${stateLabel}\n\n`;
              body += `**Source:** ${result.url}\n`;
              body += `**Topics found:** ${result.topic_count}\n\n`;

              if (result.error) {
                body += `**Error:** ${result.error}\n\n`;
              } else if (result.topics && result.topics.length > 0) {
                for (let i = 0; i < result.topics.length; i++) {
                  body += `${i + 1}. ${result.topics[i]}\n`;
                }
                body += `\n`;
              } else {
                body += `No funding topics found.\n\n`;
              }
            }

            if (output.created_items && output.created_items.length > 0) {
              body += `### Created on monday.com\n\n`;
              for (const item of output.created_items) {
                body += `- **${item.topic}** (${item.state_name})\n`;
              }
            }

            body += `\n---\n*Automated topic extraction report*\n`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title, body,
              labels: ['automated', 'topic-extraction']
            });
